<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8">
</head>
<body>
	<!-- ------- -->
	<!-- LOADING -->
	<!-- ------- -->
	<div th:fragment="loading" id="loading">
		<div class="spinner-border" role="status"></div>
		<div>[[#{personalStory.loading}]]</div>
	</div>


	<!-- -------- -->
	<!-- CAMPAIGN -->
	<!-- -------- -->
	<div th:fragment="campaign" id="campaign">
		<div class="row gx-5">
			<div class="col-3">
				<!-- Table of contents -->
				<th:block th:replace="~{fragments/tableOfContents :: tableOfContents}"></th:block>
			</div>
			<div class="col-9 position-relative">
				<!-- Edit personal story button -->
				<button type="button" id="editPersonalStoryButton" class="btn btn-primary"
						data-bs-toggle="modal" data-bs-target="#editPersonalStoryModal">
					<i class="fa-solid fa-pen-to-square"></i>
				</button>

				<div id="personalStory">
					<!-- Welcome -->
					<th:block th:if="${welcome}">
						<th:block th:replace="~{fragments/campaign :: welcome}"></th:block>
					</th:block>

					<!-- The party -->
					<th:block th:if="${party}">
						<th:block th:replace="~{fragments/campaign :: party}"></th:block>
					</th:block>
					
					<div th:each="storyObject : ${story}" class="storyObject">
						<!-- Event -->
						<th:block th:if="${storyObject.objectType.name() == 'EVENT'}">
							<th:block th:replace="~{fragments/event :: event(${storyObject})}"></th:block>
						</th:block>

						<!-- Scenario -->
						<th:block th:if="${storyObject.objectType.name() == 'SCENARIO'}">
							<th:block th:replace="~{fragments/scenario :: scenario(${storyObject})}"></th:block>
						</th:block>

						<!-- Outpost phase -->
						<th:block th:if="${storyObject.objectType.name() == 'OUTPOST_PHASE'}">
							<th:block th:replace="~{fragments/outpostPhase :: outpostPhase(${storyObject})}"></th:block>
						</th:block>
					</div>
				</div>
			</div>
		</div>
	</div>


	<!-- ------- -->
	<!-- WELCOME -->
	<!-- ------- -->
	<div th:fragment="welcome" id="welcome">
		<h1 class="title">[[#{welcome.title}]]</h1>
		<div class="text">
			[(${welcome})]
		</div>
	</div>


	<!-- ----- -->
	<!-- PARTY -->
	<!-- ----- -->
	<div th:fragment="party" id="party">
		<h1 class="title">[[#{party.title}]]</h1>
		<th:block th:each="character : ${party}">
			<th:block th:replace="fragments/character :: character(${character},true)"></th:block>
		</th:block>
	</div>


	<!-- ------------------------- -->
	<!-- EDIT PERSONAL STORY MODAL -->
	<!-- ------------------------- -->
	<div th:fragment="editPersonalStoryModal" id="editPersonalStoryModal" class="modal fade" tabindex="-1">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h1 class="modal-title fs-5">[[#{editPersonalStory.title}]]</h1>
					<div class="btn-group btn-group-sm ms-4" role="group">
						<input type="radio" class="btn-check" name="personalStoryFormat" id="personalStoryRawFormat" autocomplete="off">
						<label class="btn btn-outline-secondary" for="personalStoryRawFormat">Raw</label>
						<input type="radio" class="btn-check" name="personalStoryFormat" id="personalStoryBeautifiedFormat" autocomplete="off" checked>
						<label class="btn btn-outline-secondary" for="personalStoryBeautifiedFormat">Beautified</label>
					</div>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>			
				</div>
				<div class="modal-body">
					<textarea class="form-control" id="personalStoryInput"></textarea>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" onclick="savePersonalStory()">Save</button>
				</div>
			</div>
		</div>
	</div>


	<!-- ----------- -->
	<!-- CAMPAIGN JS -->
	<!-- ----------- -->
	<script th:fragment="campaignJs" id="campaignJs" th:inline="javascript">
		window.addEventListener("load", function() {
			/* Fetch personalStory on page load and reload all campaign content */
			reloadCampaign();

			/* Fill editPersonalStoryModal with personalStory contents on show */
			const editPersonalStoryModalElement = document.getElementById("editPersonalStoryModal");
			editPersonalStoryModalElement.addEventListener("show.bs.modal", event => {
				document.getElementById("personalStoryBeautifiedFormat").checked = true;
				const personalStory = JSON.parse(localStorage.getItem("personalStory"));
				document.getElementById("personalStoryInput").value = JSON.stringify(personalStory, null, 4);
			});

			/* Change personalStory format between raw and beautified */
			const personalStoryRawFormatInput = document.getElementById("personalStoryRawFormat");
			personalStoryRawFormatInput.addEventListener("change", event => {
				const personalStoryInput = document.getElementById("personalStoryInput");
				personalStoryInput.value = JSON.stringify(JSON.parse(personalStoryInput.value));
			});
			const personalStoryBeautifiedFormatInput = document.getElementById("personalStoryBeautifiedFormat");
			personalStoryBeautifiedFormatInput.addEventListener("change", event => {
				const personalStoryInput = document.getElementById("personalStoryInput");
				personalStoryInput.value = JSON.stringify(JSON.parse(personalStoryInput.value), null, 4);
			});
		});

		/**
		 * Reloads all campaign content by fetching the personalStory from localStorage.
		 * This has to be done when the page loads (localStorage must be accessed from the client side)
		 * and when the user edits the personalStory through the editPersonalStoryModal.
		 */
		function reloadCampaign() {
			console.log("reloadCampaign()");
			const personalStory = JSON.parse(localStorage.getItem("personalStory"));

			fetch("/personalStory", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify(personalStory)
			})
			.then(response => response.text())
			.then(responseText => {
				// Convert responseText to newCampaignDiv, a DOM element
				const tempDiv = document.createElement("div");
				tempDiv.innerHTML = responseText;
				const newCampaignDiv = tempDiv.firstChild;

				// Stop loading
				const loadingDiv = document.getElementById("loading");
				loadingDiv.classList.add("d-none");

				// Replace #campaign div content with new content
				const currentCampaignDiv = document.getElementById("campaign");
				currentCampaignDiv.innerHTML = newCampaignDiv.innerHTML;
			});
		}

		/**
		 * Saves the personalStory to localStorage and reloads the campaign content.
		 * This function is called when the user clicks the "Save" button in the editPersonalStoryModal.
		 */
		function savePersonalStory() {
			console.log("savePersonalStory()");
			const newPersonalStory = document.getElementById("personalStoryInput").value;
			// Store the JSON in raw format (not beaufitied)
			localStorage.setItem("personalStory", JSON.stringify(JSON.parse(newPersonalStory)));

			// Hide modal
			const editPersonalStoryModal = bootstrap.Modal.getInstance("#editPersonalStoryModal");
			editPersonalStoryModal.hide();

			// Start loading
			const campaignDiv = document.getElementById("campaign");
			campaignDiv.innerHTML = "";
			const loadingDiv = document.getElementById("loading");
			loadingDiv.classList.remove("d-none");

			reloadCampaign();
		}
	</script>
</body>
</html>