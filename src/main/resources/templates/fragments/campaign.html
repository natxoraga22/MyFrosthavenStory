<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8">
</head>
<body>
	<!-- ------- -->
	<!-- WELCOME -->
	<!-- ------- -->
	<div th:fragment="welcome" id="welcome" class="welcome">
		<h1 class="title">[[#{welcome.title}]]</h1>
		<div class="text">
			[(${welcome})]
		</div>
	</div>


	<!-- ----------- -->
	<!-- UNLOCKED BY -->
	<!-- ----------- -->
	<div th:fragment="unlockedBy(unlockedBy)" th:object="${unlockedBy}" class="unlockedBy">
		<i class="fa-solid fa-unlock me-1"></i> Unlocked by:
		<a th:if="*{scenario}" th:with="scenarioId = ${#numbers.formatInteger(unlockedBy.scenario,1)}"
		   class="link-secondary" th:href="|#scenario_${scenarioId}|">
			Scenario [[${scenarioId}]]
		</a>
		<a th:if="*{event}" class="link-secondary" th:href="|#event_*{event}|">
			Event [[*{event}]]
		</a>
	</div>


	<!-- ---------------- -->
	<!-- EDIT STORY MODAL -->
	<!-- ---------------- -->
	<div th:fragment="editPersonalStoryModal" id="editPersonalStoryModal" class="modal fade" tabindex="-1">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h1 class="modal-title fs-5">[[#{editPersonalStory.title}]]</h1>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>			
				</div>
				<div class="modal-body">
					<textarea class="form-control" id="editPersonalStoryInput"></textarea>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" onclick="savePersonalStory()">Save</button>
				</div>
			</div>
		</div>
	</div>


	<!-- ----------- -->
	<!-- CAMPAIGN JS -->
	<!-- ----------- -->
	<script th:fragment="campaignJs" id="campaignJs" th:inline="javascript">
		/* Fetch personalStory on page load and reload all campaign content */
		window.onload = function() {
			const personalStory = JSON.parse(localStorage.getItem("personalStory"));

			fetch("/personalStory", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify(personalStory)
			})
			.then(response => response.text())
			.then(responseText => {
				// Convert responseText to newCampaignDiv, a DOM element
				const tempDiv = document.createElement("div");
				tempDiv.innerHTML = responseText;
				const newCampaignDiv = tempDiv.firstChild;

				// Replace #campaign div content with new content
				const currentCampaignDiv = document.getElementById("campaign");
				currentCampaignDiv.innerHTML = newCampaignDiv.innerHTML;
			});
		};


		/* -------------------- */
		/* Personal story modal */
		/* -------------------- */
		const editPersonalStoryModal = document.getElementById("editPersonalStoryModal");
		editPersonalStoryModal.addEventListener("show.bs.modal", event => {
			const personalStory = JSON.parse(localStorage.getItem("personalStory"));
			document.getElementById("editPersonalStoryInput").value = JSON.stringify(personalStory);
		});

		function savePersonalStory() {
			const newPersonalStory = document.getElementById("editPersonalStoryInput").value;
			localStorage.setItem("personalStory", newPersonalStory);

			// TODO: close modal and reload campaign content
			// ...
		}
	</script>
</body>
</html>