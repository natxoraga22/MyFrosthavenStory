<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8">
</head>
<body>
	<!-- ----- -->
	<!-- EVENT -->
	<!-- ----- -->
	<div th:fragment="event" x-bind:id="'event_' + eventId" x-data="eventData(eventId, chosenOptionsIds)">
		<template x-if="!loadingEvent">
			<div class="event">
				<!-- Title -->
				<div class="title">
					<h1 class="title" x-jsz>
						<span class="titleSecondary">{{event.id}} Â·</span>
						{{$store.typesAndSeasonsStrings[event.typeAndSeason]}}
						[[#{event.title}]]
					</h1>
					<!-- Unlocked by -->
					<template x-if="event.unlockedBy">
						<div x-data="{ unlockedBy: event.unlockedBy }">
							<th:block th:replace="~{fragments/common/unlockedBy :: unlockedBy}"/>
						</div>
					</template>
				</div>

				<!-- Card image -->
				<div x-data="{ frontImgSrc: frontImgSrc, backImgSrc: backImgSrc }">
					<th:block th:replace="~{fragments/common/playingCard :: playingCard}"/>
				</div>

				<!-- Text -->
				<div class="text" x-jsz>
					{{event.text}}
				</div>

				<!-- Options -->
				<div class="options">
					<template x-for="(chosenOptionId, index) in chosenOptionsIds" :key="chosenOptionId">
						<div x-data="{ option: event.options[chosenOptionId] }">
							<template x-if="option">
								<th:block th:replace="~{:: option}"/>
							</template>
						</div>
					</template>
				</div>

				<!-- Outpost attack -->
				<template x-if="!skipAttack">
					<div x-data="{ outpostAttack: event.outpostAttack }">
						<hr>
						<th:block th:replace="~{:: outpostAttack}"/>
					</div>
				</template>

				<!-- Random scenario section -->
				<!--
				<template x-if="event.randomScenarioSection">
					<div x-data="{ section: event.randomScenarioSection }">
						<th:block th:replace="~{fragments/section :: section}"/>
					</div>
				</template>
				-->
			</div>
		</template>
	</div>


	<!-- ------ -->
	<!-- OPTION -->
	<!-- ------ -->
	<div th:fragment="option" class="option">
		<!-- Trigger -->
		<div class="trigger" x-show="index == 0">
			<i class="fa-solid fa-angles-right fa-sm"></i>
			<strong>[[#{event.option}]]<span x-show="option.id" x-jsz> {{option.id}}</span>:</strong>
			<span x-jsz>{{option.trigger}}</span>
		</div>

		<!-- Text -->
		<div class="text">
			<span x-show="option.requirement" x-jsz>{{option.requirement}}: </span>
			<span x-jsz>{{option.text}}</span>
		</div>

		<!-- Rewards -->
		<template x-if="event.rewards">
			<div class="rewards" x-data="{ rewards: option.rewards }">
				<th:block th:replace="~{fragments/rewards :: rewardsBody}"/>
			</div>
		</template>
	</div>


	<!-- -------------- -->
	<!-- OUTPOST ATTACK -->
	<!-- -------------- -->
	<div th:fragment="outpostAttack" class="outpostAttack">
		<!-- Attack -->
		<bs:flex align="center">
			<div class="attack" x-jsz>
				<img class="icon" th:src="@{__${imgUrl}__/icons/attack.png}">
				{{outpostAttack.attack}}
			</div>
			<div class="target" x-jsz>
				<img class="icon" th:src="@{__${imgUrl}__/icons/target.png}">
				{{outpostAttack.target}}
			</div>
			<div class="targetPriority" x-jsz>
				{{outpostAttack.targetPriority}}
			</div>
		</bs:flex>
		
		<!-- Text -->
		<div class="text" x-jsz>
			{{outpostAttack.text}}
		</div>

		<!-- Rewards -->
		<template x-if="outpostAttack.rewards">
			<div class="rewards" x-data="{ rewards: outpostAttack.rewards }">
				<th:block th:replace="~{fragments/rewards :: rewardsBody}"/>
			</div>
		</template>
	</div>


	<!-- -------- -->
	<!-- EVENT JS -->
	<!-- -------- -->
	<script th:fragment="eventJs" th:inline="javascript">
		document.addEventListener("alpine:init", () => {
			Alpine.data("eventData", (eventId, chosenOptionsIds) => ({
				chosenOptionsIds: chosenOptionsIds ?? [],
				event: {},
				loadingEvent: true,

				get frontImgSrc() { return this.$store.imgUrl + "/events/" + this.event.typeAndSeason + "/" + this.event.id + ".png" },
				get backImgSrc() { return this.$store.imgUrl + "/events/" + this.event.typeAndSeason + "/" + this.event.id + "_back.png" },

				get skipAttack() {
					if (!this.event.outpostAttack || !this.chosenOptionsIds) return true;
					for (let chosenOptionId of this.chosenOptionsIds) {
						const chosenOption = this.event.options[chosenOptionId];
						if (chosenOption?.skipAttack) return true;
					}
				},

				init() {
					this.loadEvent();
					// Event listeners
					window.addEventListener("changed-chosen-options", event => this.setChosenOptionsIds(event.detail));
				},

				loadEvent() {
					log.entry(eventId);
					this.loadingEvent = true;
					// Get event data URL
					let eventDataUrl = /*[[@{__${eventDataPage.url}__}]]*/ "";
					eventDataUrl = eventDataUrl.replace("{eventId}", eventId);
					// AJAX GET request
					ajaxGet(eventDataUrl)
						.success(event => this.event = event)
						.error(errorData => log.error("ERROR fetching event", errorData.message))
						.always(() => this.loadingEvent = false);
					log.exit();
				},

				// "changed-chosen-options" event handler
				setChosenOptionsIds(newChosenOptionsIds) {
					log.entry(newChosenOptionsIds);
					this.chosenOptionsIds = [...newChosenOptionsIds];
					log.exit();
				}
			}));
		});
	</script>
</body>
</html>