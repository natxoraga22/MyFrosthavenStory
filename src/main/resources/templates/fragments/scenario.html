<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8">
</head>
<body>
	<!-- -------- -->
	<!-- SCENARIO -->
	<!-- -------- -->
	<div th:fragment="scenario" x-bind:id="'scenario_' + scenario.id" x-data="scenarioData(scenarioId, scenarioPath)">
		<template x-if="Object.keys(scenario).length > 0">
			<div class="scenario">
				<!-- Title -->
				<div class="title">
					<!-- Questline -->
					<template x-if="scenario.questLine">
						<div class="questLine" x-bind:class="uncapitalizedQuestLine" x-jsz>
							{{scenario.questLine}}
						</div>
					</template>
					<h1>
						<!-- Id and name -->
						<span class="titleSecondary" x-jsz>{{Number(scenario.id)}} Â·</span>
						<span x-jsz>{{scenario.name}}</span>
						<!-- Requirements -->
						<template x-if="scenario.requirement">
							<div x-data="{ get requirement() { return scenario.requirement } }">
								<th:block th:replace="~{:: requirement}"/>
							</div>
						</template>
					</h1>
					<!-- Unlocked by -->
					<template x-if="scenario.unlockedBy">
						<div x-data="{ get unlockedBy() { return scenario.unlockedBy } }">
							<th:block th:replace="~{fragments/common/unlockedBy :: unlockedBy}"/>
						</div>
					</template>
					<!-- Location -->
					<template x-if="scenario.location">
						<div class="subtitle" x-jsz>
							<i class="fa-solid fa-map-location me-1"></i>
							{{scenario.location}}
						</div>
					</template>
				</div>

				<!-- Scenario goals -->
				<template x-if="scenario.goals">
					<bs:card class="fhCard goals">
						<bs:cardHeader>[[#{scenario.goals}]]</bs:cardHeader>
						<bs:cardBody x-jsz>{{scenario.goals}}</bs:cardBody>
					</bs:card>
				</template>
				
				<!-- Scenario effects -->
				<template x-if="scenario.effects">
					<bs:card class="fhCard effects">
						<bs:cardHeader>[[#{scenario.effects}]]</bs:cardHeader>
						<bs:cardBody x-jsz>{{scenario.effects}}</bs:cardBody>
					</bs:card>
				</template>

				<!-- Sections -->
				<div class="sections">
					<template x-for="scenarioPathItem in scenarioPath" x-bind:key="scenarioPathItem">
						<div x-data="{ sectionId: null, get section() { return scenario.sections[scenarioPathItem] } }">
							<template x-if="section">
								<th:block th:replace="~{fragments/section :: section}"/>
							</template>
						</div>
					</template>
				</div>

				<!-- Random scenario section -->
				<!--
				<th:block th:if="*{randomScenarioSection}">
					<th:block th:replace="~{fragments/section :: section(*{randomScenarioSection})}"></th:block>
				</th:block>
				-->
			</div>
		</template>
	</div>


	<!-- ----------- -->
	<!-- REQUIREMENT -->
	<!-- ----------- -->
	<div th:fragment="requirement" class="requirement">
		<!-- Transport -->
		<template x-if="requirement.transport">
			<div class="transport">
				<img x-bind:src="getTransportIconUrl(requirement.transport)">
			</div>
		</template>
		<!-- Status -->
		<template x-if="requirement.status">
			<div class="status" x-jsz>
				{{requirement.status}}
			</div>
		</template>
	</div>


	<!-- ----------- -->
	<!-- SCENARIO JS -->
	<!-- ----------- -->
	<script th:fragment="scenarioJs" th:inline="javascript">
		document.addEventListener("alpine:init", () => {
			Alpine.data("scenarioData", (scenarioId, scenarioPath) => ({
				scenarioPath: scenarioPath ?? [],
				scenario: {},

				init() {
					this.setScenario(scenarioId, false);
					// Event listeners
					window.addEventListener("changed-scenario-id", event => this.setScenario(event.detail));
					window.addEventListener("changed-scenario-path", event => this.setScenarioPath(event.detail));
				},

				get uncapitalizedQuestLine() {
					const questLine = this.scenario.questLine;
					return questLine?.charAt(0).toLowerCase() + questLine?.slice(1);
				},

				getTransportIconUrl(transport) { return this.$store.imgUrl + "/icons/" + transport + ".png" },

				// "changed-scenario-id" event handler
				setScenario(scenarioId, clearScenarioPath = true) {
					log.entry(scenarioId, clearScenarioPath);
					if (scenarioId) this.scenario = this.$store.scenariosMap[scenarioId] ?? {};
					if (clearScenarioPath || this.scenarioPath.length == 0) this.scenarioPath = [...this.scenario.path];
					log.exit();
				},

				// "changed-scenario-path" event handler
				setScenarioPath(newScenarioPath) {
					log.entry(newScenarioPath);
					this.scenarioPath = [...newScenarioPath];
					log.exit();
				}
			}));
		});
	</script>
</body>
</html>